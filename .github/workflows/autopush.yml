name: 'autopush_webhook_container'

on:
  workflow_run:
    workflows: ['build_webhook_container']
    types:
      - 'completed'
    branches:
      - 'main'

concurrency:
  group: '${{ github.workflow }}-${{ github.ref }}'

env:
  WIF_PROVIDER: 'projects/727875687543/locations/global/workloadIdentityPools/github-actions-on-gcp-p-a63b4c/providers/github-actions-on-gcp-p-a63b4c'
  WIF_SERVICE_ACCOUNT: 'github-automation-bot@gha-on-gcp-p-a63b4c.iam.gserviceaccount.com'

  DOCKER_REGISTRY: 'us-docker.pkg.dev'
  DOCKER_TAG: '${{ github.event.workflow_run.head_sha }}'
  DOCKER_REPO: 'us-docker.pkg.dev/ghss-artifacts-p-25/docker-images'
  IMAGE_NAME: 'gha-webhook'

  AUTOPUSH_SERVICE_NAME: 'action-dispatcher-1863'
  AUTOPUSH_PROJECT_ID: 'action-dispatcher-webhook-a-18'
  AUTOPUSH_REGION: 'us-central1'
  RUNNER_LABEL: 'self-hosted-autopush'

permissions:
  contents: 'read'
  id-token: 'write'

jobs:
  autopush:
    name: 'Deploy to autopush'
    runs-on: 'ubuntu-latest'
    if: |
      github.event.workflow_run.conclusion == 'success'
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683' # ratchet:actions/checkout@v4

      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@a6e2e39c0a0331da29f7fd2c2a20a427e8d3ad1f' # ratchet:google-github-actions/auth@v2
        with:
          workload_identity_provider: '${{ env.WIF_PROVIDER }}'
          service_account: '${{ env.WIF_SERVICE_ACCOUNT }}'
          token_format: 'access_token'

      - name: 'Setup gcloud'
        uses: 'google-github-actions/setup-gcloud@98ddc00a17442e89a24bbf282954a3b65ce6d200' # ratchet:google-github-actions/setup-gcloud@v2
        with:
          version: '529.0.0'

      - name: 'Deploy to Cloud Run'
        run: |-
          gcloud run services update ${{ env.AUTOPUSH_SERVICE_NAME }} \
            --project="${{ env.AUTOPUSH_PROJECT_ID }}" \
            --region="${{ env.AUTOPUSH_REGION }}" \
            --image="${{ env.DOCKER_REPO }}/${{ env.IMAGE_NAME }}:${{ env.DOCKER_TAG }}-amd64" \
            --ingress="internal-and-cloud-load-balancing" \
            --update-env-vars="RUNNER_LABEL=${{ env.RUNNER_LABEL }}"
          # If traffic was manually shifted, this will ensure latest revision runs.
          gcloud run services update-traffic ${{ env.AUTOPUSH_SERVICE_NAME }} \
            --project="${{ env.AUTOPUSH_PROJECT_ID }}" \
            --region="${{ env.AUTOPUSH_REGION }}" \
            --to-latest
