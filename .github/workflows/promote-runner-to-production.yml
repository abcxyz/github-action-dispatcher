name: 'Promote Runner to Production'

on:
  schedule:
    - cron: '0 12 * * 5' # Run every Friday at 12:00 PM UTC
  workflow_dispatch:
    inputs:
      manual_cur_tag:
        description: 'Manually set the tag for the `cur` image (e.g., a commit SHA). Overrides normal promotion logic.'
        required: false
        type: 'string'
      manual_prev_tag:
        description: 'Manually set the tag for the `prev` image (e.g., a commit SHA). Overrides normal promotion logic.'
        required: false
        type: 'string'

env:
  WIF_PROVIDER: 'projects/727875687543/locations/global/workloadIdentityPools/github-actions-on-gcp-p-a63b4c/providers/github-actions-on-gcp-p-a63b4c'
  WIF_SERVICE_ACCOUNT: 'github-automation-bot@gha-on-gcp-p-a63b4c.iam.gserviceaccount.com'
  GAR_LOCATION: 'us'
  GAR_IMAGE_NAME: 'ghss-artifacts-p-25/docker-images/gha-runner'

permissions:
  contents: 'read'
  id-token: 'write'

jobs:
  promote:
    runs-on: 'ubuntu-latest'
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955' # ratchet:actions/checkout@v4

      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@c200f3691d83b41bf9bbd8638997a462592937ed' # ratchet:google-github-actions/auth@v2
        with:
          workload_identity_provider: '${{ env.WIF_PROVIDER }}'
          service_account: '${{ env.WIF_SERVICE_ACCOUNT }}'
          token_format: 'access_token'

      - name: 'Setup gcloud'
        uses: 'google-github-actions/setup-gcloud@e427ad8a34f8676edf47cf7d7925499adf3eb74f' # ratchet:google-github-actions/setup-gcloud@v2
        with:
          version: '529.0.0'

      - uses: 'docker/login-action@465a07811f14bebb1938fbed4728c6a1ff8901fc' # ratchet:docker/login-action@v2
        with:
          username: 'oauth2accesstoken'
          password: '${{ steps.auth.outputs.access_token }}'
          registry: '${{ env.GAR_LOCATION }}-docker.pkg.dev'

      - name: 'Promote Images'
        run: |
          set -e
          IMAGE_URI="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GAR_IMAGE_NAME }}"

          MANUAL_CUR_TAG="${{ github.event.inputs.manual_cur_tag }}"
          MANUAL_PREV_TAG="${{ github.event.inputs.manual_prev_tag }}"

          if [ -n "${MANUAL_CUR_TAG}" ]; then
            echo "Manual override for 'cur' tag detected."

            # Determine and set the 'prev' tag first
            if [ -n "${MANUAL_PREV_TAG}" ]; then
              echo "Manual override for 'prev' tag also detected. Setting 'prev' to point to image with tag ${MANUAL_PREV_TAG}"
              docker pull "${IMAGE_URI}:${MANUAL_PREV_TAG}"
              docker tag "${IMAGE_URI}:${MANUAL_PREV_TAG}" "${IMAGE_URI}:prev"
            else
              echo "No manual 'prev' tag. Setting 'prev' to the current 'cur'."
              docker pull "${IMAGE_URI}:cur"
              docker tag "${IMAGE_URI}:cur" "${IMAGE_URI}:prev"
            fi

            # Now set the new 'cur' tag
            echo "Setting 'cur' to point to image with tag ${MANUAL_CUR_TAG}"
            docker pull "${IMAGE_URI}:${MANUAL_CUR_TAG}"
            docker tag "${IMAGE_URI}:${MANUAL_CUR_TAG}" "${IMAGE_URI}:cur"

            # Push both tags
            echo "Pushing new 'cur' and 'prev' tags."
            docker push "${IMAGE_URI}:cur"
            docker push "${IMAGE_URI}:prev"
          else
            echo "No manual overrides. Running automatic promotion."
            docker pull "${IMAGE_URI}:next"
            docker pull "${IMAGE_URI}:cur"

            NEXT_DIGEST=$(docker inspect --format='{{.Id}}' "${IMAGE_URI}:next")
            CUR_DIGEST=$(docker inspect --format='{{.Id}}' "${IMAGE_URI}:cur")

            if [ "${NEXT_DIGEST}" != "${CUR_DIGEST}" ]; then
              echo "Promoting 'next' to 'cur'"
              docker tag "${IMAGE_URI}:cur" "${IMAGE_URI}:prev"
              docker push "${IMAGE_URI}:prev"
              docker tag "${IMAGE_URI}:next" "${IMAGE_URI}:cur"
              docker push "${IMAGE_URI}:cur"
            else
              echo "'next' and 'cur' images are the same. No promotion needed."
            fi
          fi
